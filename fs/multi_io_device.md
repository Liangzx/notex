# multi io device

## 概念

多路径 I/O（Multipath Input/Output）设备是指通过多个物理路径连接到同一存储设备的配置。这种配置允许数据可以通过不同的路径传输，从而提高了系统的可靠性、性能和可用性。多路径 I/O 主要用于企业级存储系统中，如 SAN（存储区域网络），以确保即使某些硬件组件或路径出现故障，仍然可以持续访问存储资源。

物理路径：在多路径 I/O（Multipath Input/Output）环境中，物理路径指的是从服务器主机到存储设备之间的实际硬件连接通道。每条物理路径包括了从主机的 HBA（Host Bus Adapter，主机总线适配器）卡、通过交换机或直接连接到存储系统的端口、以及最终到达存储控制器和 LUN（逻辑单元号）的所有物理组件。

### 物理路径的组成部分

主机总线适配器 (HBA)：这是安装在服务器上的硬件卡，用于与存储网络通信。它可以是光纤通道 HBA、iSCSI 网络接口卡（NIC），或者是 SAS/SATA 控制器等。
存储网络：对于光纤通道 SAN（FC SAN），这通常涉及光纤通道交换机；对于 iSCSI，则是标准以太网交换机；而对于直接附加存储（DAS），可能是 SAS 或 SATA 电缆。
存储控制器端口：存储阵列上的一个或多个端口，它们接收来自主机的 I/O 请求并将其转发给适当的 LUN。
LUN（逻辑单元号）：这是在存储系统中定义的一个逻辑卷，它代表了一块可以被操作系统识别和使用的存储空间。

多路径 I/O 中的物理路径示例：
假设你有一个双控制器 SAN 存储系统，并且每个控制器有两个光纤通道端口。同时，你的服务器配备了两个 FC HBA 卡，每个 HBA 卡都连接到了不同的 SAN 交换机上。那么，在这种配置下，你将拥有四条独立的物理路径：
- 路径 1：从服务器的 HBA 卡 1 到 SAN 交换机 A 再到存储控制器 1 的端口 1。
- 路径 2：从服务器的 HBA 卡 1 到 SAN 交换机 A 再到存储控制器 2 的端口 1。
- 路径 3：从服务器的 HBA 卡 2 到 SAN 交换机 B 再到存储控制器 1 的端口 2。
- 路径 4：从服务器的 HBA 卡 2 到 SAN 交换机 B 再到存储控制器 2 的端口 2。

## 多路径 I/O 的工作原理

冗余路径：每个多路径 I/O 设备通常会通过两个或更多的物理路径连接到主机。这些路径可能包括不同的光纤通道（FC）、iSCSI 或 SAS 连接。
负载均衡：多路径软件可以根据预先设定的策略，在不同路径之间分配读写请求，以实现负载均衡。这不仅提升了性能，还延长了各个路径的使用寿命。
故障切换（Failover）：如果一条路径发生故障，多路径软件能够自动将流量切换到其他可用路径上，而不会中断服务。这一特性极大地增强了系统的高可用性和容错能力。
路径恢复（Failback）：当之前失败的路径恢复正常后，多路径软件可以选择是否重新使用该路径，具体行为取决于配置的策略。
路径选择策略（Path Selection Policy, PSP）：
- Round Robin (RR)：轮流使用所有可用路径。
- Least Queue Depth (LQD)：选择队列深度最小的路径。
- Service-time Weighted Path Selection (SWPS)：基于响应时间加权选择路径。
- Fixed：总是使用指定的首选路径，除非它不可用。

优先级和权重：可以为每条路径设置优先级或权重，以便更精细地控制流量分配。

## 多路径 I/O 的优点

提高可靠性：通过提供冗余路径，减少了单点故障的风险。
增强性能：利用多条路径并行处理 I/O 请求，可以显著提升吞吐量。
简化管理：从逻辑上看，多路径设备表现为一个单一的设备，便于管理和维护。
支持动态调整：可以在不中断服务的情况下添加或移除路径。

## 实现多路径 I/O

```shell
# 为了在 Linux 系统中实现多路径 I/O，通常需要以下几个步骤：
# 1. 安装必要的软件包：在大多数 Linux 发行版中，你需要安装 multipath-tools 包，它提供了命令行工具和服务来管理多路径设备。
# 2. 配置多路径：编辑 /etc/multipath.conf 文件，定义如何识别和配置多路径设备。你可以指定厂商特定的设置、默认路径选择策略等。
# 3. 加载内核模块：确保 device-mapper-multipath 内核模块已加载。可以使用以下命令检查和加载：
lsmod | grep dm_multipath
sudo modprobe dm_multipath

# 4. 启动和启用服务：使用 systemctl 或 service 命令启动并启用 multipathd 服务：
sudo systemctl start multipathd
sudo systemctl enable multipathd

# 5. 验证配置：使用 multipath -ll 命令列出所有检测到的多路径设备及其状态信息。例如：
sudo multipath -ll
```
